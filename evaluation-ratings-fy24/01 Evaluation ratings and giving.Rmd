---
title: "Evaluation ratings and giving"
output:
  html_notebook:
    code_folding: hide
    toc: true
    toc_float: true
---

# Goals

Look at the relationship between evaluation and qualification ratings and subsequent (5-year?) giving.

# Setup

```{r setup}
library(tidyverse)
library(readxl)
library(scales)
library(foreach)
library(wranglR)

# Hide the dplyr .groups message
options(dplyr.summarise.inform = FALSE)
```

# Eval data

```{r}
evals <- read_xlsx("data/2024-04-12 all evals.xlsx", guess_max = 1E6)
```

```{r}
# Fix datatypes
evals <- evals %>%
  # Factors
  mutate(
    across(
      c(PRIMARY_IND, RECORD_STATUS_CODE, PROGRAM_GROUP, EVALUATION_TYPE, EVALUATION_TYPE_DESC
           , ACTIVE_IND, RATING_CODE, RATING_DESC, EVALUATOR_ID_NUMBER)
      , factor
    )
  ) %>%
  # Numerics
  mutate(
    FIRST_KSM_YEAR = as.numeric(FIRST_KSM_YEAR)
    , eval_fy = wranglR::ToFiscalDate(EVALUATION_DATE, start.month = 9)
  )
```

```{r}
summary(evals)
```

## Eval exploration

How many rated by grad year?

```{r}
evals %>%
  filter(FIRST_KSM_YEAR >= 1900) %>%
  ggplot(aes(x = FIRST_KSM_YEAR, fill = EVALUATION_TYPE_DESC)) +
  geom_histogram(binwidth = 1) +
  labs(title = "Ratings by grad year (incl. multiple ratings per entity)") +
  guides(fill = "none") +
  facet_grid(EVALUATION_TYPE_DESC ~ .)
```

How many rated by program?

```{r}
evals %>%
  ggplot(aes(x = PROGRAM_GROUP, fill = EVALUATION_TYPE_DESC)) +
  geom_bar() +
  labs(title = "Rated by program group (incl. multiple ratings per entity)") +
  guides(fill = "none") +
  facet_grid(EVALUATION_TYPE_DESC ~ .)
```

```{r}
rating_amt_low_labs <- evals %>%
  select(RATING_AMT_LOW) %>%
  unique() %>%
  arrange(RATING_AMT_LOW) %>%
  mutate(
    rating = case_when(
      # Skip NULL
      is.na(RATING_AMT_LOW) ~ "NA"
      # Over 1M gets M
      , RATING_AMT_LOW >= 1E6 ~ "$" %>% paste0(round(RATING_AMT_LOW / 1E6, 1), "M")
      # Else use K
      , TRUE ~ "$" %>% paste0(round(RATING_AMT_LOW / 1E3, 1), "K")
    )
  )

rating_amt_labs <- rating_amt_low_labs$rating
names(rating_amt_labs) <- rating_amt_low_labs$RATING_AMT_LOW

evals %>%
  ggplot(aes(x = factor(RATING_AMT_LOW), fill = EVALUATION_TYPE_DESC)) +
  geom_bar() +
  labs(title = "Ratings by level (incl. multiple ratings per entity)", x = NULL) +
  guides(fill = "none") +
  scale_x_discrete(labels = rating_amt_labs) +
  facet_grid(EVALUATION_TYPE_DESC ~ .)
```

Correlation between grad year and ratings?

```{r, fig.height = 10, fig.width = 7}
evals %>%
  mutate(rating = factor(RATING_AMT_LOW)) %>%
  filter(FIRST_KSM_YEAR >= 1900) %>%
  ggplot(aes(x = FIRST_KSM_YEAR
             , color = EVALUATION_TYPE_DESC, fill = EVALUATION_TYPE_DESC)) +
  geom_density(alpha = .5) +
  labs(title = "Ratings by grad year") +
  facet_grid(rating ~ .
             , labeller = labeller(rating = rating_amt_labs)) +
  # Group means
  geom_vline(data = evals %>%
               mutate(rating = factor(RATING_AMT_LOW)) %>%
               group_by(rating, EVALUATION_TYPE_DESC) %>%
               mutate(yrmean = mean(FIRST_KSM_YEAR, na.rm = TRUE))
             , aes(xintercept = yrmean, color = EVALUATION_TYPE_DESC))
```

Relationship between program group and ratings?

```{r, fig.height = 8, fig.width = 12}
evals %>%
  ggplot(aes(x = RATING_AMT_LOW, fill = EVALUATION_TYPE_DESC)) +
  geom_bar(position = "dodge") +
  labs(title = "Ratings by level (incl. multiple ratings per entity)", x = NULL) +
  scale_x_log10(breaks = names(rating_amt_labs) %>% as.numeric
                , labels = rating_amt_labs) +
  facet_grid(PROGRAM_GROUP ~ .) +
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  # Group means
  geom_vline(data = evals %>%
             group_by(PROGRAM_GROUP, EVALUATION_TYPE_DESC) %>%
             mutate(rtmean = mean(RATING_AMT_LOW, na.rm = TRUE))
           , aes(xintercept = rtmean, color = EVALUATION_TYPE_DESC))
```

Can't tell anything; redo with density rather than counts. Also filter for only the big programs.

```{r, fig.height = 8, fig.width = 12}
evals %>%
  filter(PROGRAM_GROUP %in% c("FT", "EMP", "TMP")) %>%
  group_by(PROGRAM_GROUP, EVALUATION_TYPE_DESC) %>%
  mutate(
    n = n()
    , pct = n/sum(n)
  ) %>%
  group_by(PROGRAM_GROUP, EVALUATION_TYPE_DESC, RATING_AMT_LOW) %>%
  summarise(
    percent = sum(pct)
  ) %>%
  ggplot(aes(x = RATING_AMT_LOW, y = percent, fill = EVALUATION_TYPE_DESC)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Ratings by level and program (incl. multiple ratings per entity)", x = NULL) +
  scale_x_log10(breaks = names(rating_amt_labs) %>% as.numeric
                , labels = rating_amt_labs) +
  scale_y_continuous(labels = scales::percent) +
  facet_grid(PROGRAM_GROUP ~ .) +
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  # Group means
  geom_vline(data = evals %>%
             filter(PROGRAM_GROUP %in% c("FT", "EMP", "TMP")) %>%
             group_by(PROGRAM_GROUP, EVALUATION_TYPE_DESC) %>%
             mutate(rtmean = mean(RATING_AMT_LOW, na.rm = TRUE))
           , aes(xintercept = rtmean, color = EVALUATION_TYPE_DESC))
```

FT ratings apparently skew a bit higher and TMP a bit lower, but no big differences.

# Gift data

```{r}
gifts <- read_xlsx("data/2024-04-25 KSM gifts from rated.xlsx", guess_max = 1E6)
```

```{r}
# Fix datatypes
gifts <- gifts %>%
  # Factors
  mutate(
    across(
      c(TX_GYPM_IND, TRANSACTION_TYPE, ASSOCIATED_DESC, PAYMENT_TYPE, ALLOC_SHORT_NAME)
      , factor
    )
  )
```

## Gift exploration

```{r, fig.width = 9}
gifts %>%
  ggplot(aes(x = RECOGNITION_CREDIT)) +
  geom_histogram(alpha = .75, binwidth = .33) +
  scale_x_log10(breaks = c(10^(0:7)), labels = scales::dollar, minor_breaks = NULL) +
  labs(title = "Gift distribution (GP)", x = "Recognition credit")
```

```{r, fig.width = 9}
gifts %>%
  ggplot(aes(x = RECOGNITION_CREDIT)) +
  geom_density(aes(color = factor(FISCAL_YEAR)), alpha = .5, bw = .15) +
  scale_x_log10(breaks = c(10^(0:7)), labels = scales::dollar, minor_breaks = NULL) +
  labs(title = "Gift distribution (GP) by fiscal year", x = "Recognition credit", color = "Fiscal year")
```

Based on the color gradient, looks like the average has been shifting right over time.

# Time and inflation trends

```{r}
cpiu <- read_xlsx(path = "data/CPI-U.xlsx", guess_max = 1E6) %>%
  mutate(
    stat = "cpiu"
  )
```


```{r}
gifts %>%
  group_by(FISCAL_YEAR) %>%
  summarise(
    min = min(RECOGNITION_CREDIT)
    , med = median(RECOGNITION_CREDIT)
    , mean = mean(RECOGNITION_CREDIT)
    , max = max(RECOGNITION_CREDIT)
  ) %>%
  pivot_longer(
    cols = min:max
    , names_to = "stat"
    , values_to = "recognition_credit"
  ) %>%
  filter(
    FISCAL_YEAR >= 1975
  ) %>%
  ggplot(aes(x = FISCAL_YEAR)) +
  geom_line(aes(y = recognition_credit, color = stat)) +
  geom_line(data = cpiu %>% filter(Year >= 1975), aes(x = Year, y = `CPI-U`), linetype = "dashed") +
  scale_y_log10(breaks = c(10^(0:7)), labels = scales::dollar, minor_breaks = NULL) +
  labs(y = "Recognition credit", x = "Fiscal year", color = "stat (rec credit)"
    , title = "Change in gift distribution (GP) over time vs CPI-U")
```

Average and median giving has outpaced inflation (dashed reference line).

```{r}
# cpiu %>%
#   filter(Year >= 1975) %>%
#   ggplot(aes(x = Year, y = `CPI-U`)) +
#   geom_line()
```

```{r}
summary_evals <- evals %>%
  group_by(eval_fy) %>%
  summarise(
    min = min(RATING_AMT_LOW)
    , med = median(RATING_AMT_LOW)
    , mean = mean(RATING_AMT_LOW)
    , max = max(RATING_AMT_LOW)
  ) %>%
  pivot_longer(
    cols = min:max
    , names_to = "stat"
    , values_to = "rating_amt_low"
  )

summary_evals %>%
  ggplot(aes(x = eval_fy)) +
  geom_line(aes(y = rating_amt_low, color = stat)) +
  geom_line(
    data = cpiu %>% filter(Year >= min_eval_fy) %>% mutate(`CPI-U` = `CPI-U`)
    , aes(x = Year, y = `CPI-U`*1000), linetype = "dashed") +
  scale_y_log10(breaks = c(10^(0:7)), labels = scales::dollar, minor_breaks = NULL) +
  labs(y = "Min eval rating", x = "Fiscal year", color = "stat (eval rating)"
    , title = "Change in evaluation ratings over time vs CPI-U*1000")
```


# Merged data

```{r}

```

