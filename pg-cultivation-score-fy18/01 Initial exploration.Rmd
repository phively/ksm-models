---
title: "01 Initial exploration"
output: html_notebook
---

# Goal

Understand how the PG cultivation score, based on based on [Ben Porter's Donor Cultivation Checklist](https://www.case.org/currents/x74757), is related to future giving behavior at various capacity rating levels.

# Setup

```{r setup, message = FALSE, warning = FALSE}
library(tidyverse)
library(readxl)
```

# Import data

The PG cultivation score was calculated from [this view](https://github.com/phively/nu-plsql/blob/c1687d2318741cde184d18c5f8805660148ee79a/views/v_pg_checklist.sql), and the data file was generated by [this SQL code](https://github.com/phively/ksm-models/blob/master/pg-cultivation-score-fy18/code/pg-cultivation-score-data.sql).

```{r}
pool <- readxl::read_xlsx(
  path = 'data/2018-07-18 PG scores for all active prospects.xlsx'
  , sheet = 'With'
) %>% mutate(
  # Create factors
  QUAL_LEVEL = factor(QUAL_LEVEL)
  , PREF_ADDR = factor(PREF_ADDR)
  , PROSPECT_MGR = factor(PROSPECT_MGR)
  , MULTI_OR_SINGLE_INTEREST = factor(MULTI_OR_SINGLE_INTEREST)
  , MG_ID_MODEL_DESC = MG_ID_MODEL_DESC %>% str_remove('Major Gifts Identification ') %>% factor()
  , MG_PR_MODEL_DESC = MG_PR_MODEL_DESC %>% str_remove('Major Gifts Prioritization ') %>% factor()
  # Create booleans
  , PG_PROSPECT_FLAG = !is.na(PG_PROSPECT_FLAG)
  # Create numeric
  , MG_ID_MODEL_SCORE = as.numeric(MG_ID_MODEL_SCORE)
  , MG_ID_MODEL_YEAR = as.numeric(MG_ID_MODEL_YEAR)
  , MG_PR_MODEL_SCORE = as.numeric(MG_PR_MODEL_SCORE)
  , MG_PR_MODEL_YEAR = as.numeric(MG_PR_MODEL_YEAR)
)

# Row count
nrow(pool)
```

# Numeric summary statistics

```{r numeric_summary_functions}
# Function to compute percentiles from the empirical CDF
get_percentiles <- function(
      lbound     # smallest observation for which to compute percentile
    , ubound     # largest observation for which to compute percentile
    , group1     # First comparison group
    , group2 = 1 # Optional second comparison group
    , group3 = 1 # Optional third comparison group
  ) {
      data.frame(
        x = lbound:ubound
        , g1 = ecdf(group1)(lbound:ubound) %>% scales::percent()
        , g2 = ecdf(group2)(lbound:ubound) %>% scales::percent()
        , g3 = ecdf(group3)(lbound:ubound) %>% scales::percent()
      ) %>%
      return()
    }
```


### Cultivation score

Begin with the distribution of cultivation scores.

```{r}
lower_bound <- min(pool$CULTIVATION_SCORE)
upper_bound <- max(pool$CULTIVATION_SCORE)
summary(pool$CULTIVATION_SCORE)
```

```{r}
pool %>%
  ggplot(aes(x = CULTIVATION_SCORE)) +
  geom_histogram(binwidth = 1, alpha = .5) +
  scale_x_continuous(breaks = seq(lower_bound, upper_bound, by = 2))
```

The PG cultivation score ranges from 0 to 12, with most of the data between 1 and 3. 0 implies a totally unengaged non-alumni prospect.

Here's a look at principal gift prospects:

```{r}
pool %>%
  ggplot(aes(x = CULTIVATION_SCORE, fill = PG_PROSPECT_FLAG)) +
  geom_histogram(binwidth = 1, alpha = .5, aes(y = ..density..)) +
  scale_x_continuous(breaks = seq(lower_bound, upper_bound, by = 2)) +
  facet_grid(PG_PROSPECT_FLAG ~ .)
```

```{r, rows.print = 100}
get_percentiles(
  lower_bound
  , upper_bound
  , pool %>% select(CULTIVATION_SCORE) %>% unlist() # All prospects
  , pool %>% filter(!PG_PROSPECT_FLAG) %>% select(CULTIVATION_SCORE) %>% unlist() # Non-PG only
  , pool %>% filter(PG_PROSPECT_FLAG) %>% select(CULTIVATION_SCORE) %>% unlist() # PG only
) %>% select(score = x, overall_percentile = g1, non_PG_percentile = g2, PG_percentile = g3)
```

PG prospects have much more density in the right tail - I wouldn't read too much into it, though, because the PG checklist items were based on historical engagement patterns of these donors.

### Major gift identification scores

Let's look at similar metrics for the major gift identification score.

```{r}
summary(pool$MG_ID_MODEL_SCORE)
```

Right off the bat, we see `r pool$MG_ID_MODEL_SCORE %>% is.na() %>% sum() %>% I()` out of the `r nrow(pool) %>% I()` prospects in the file do not have this score.

```{r}
pool %>% filter(!is.na(MG_ID_MODEL_SCORE)) %>%
  ggplot(aes(x = MG_ID_MODEL_SCORE)) +
  geom_density() +
  geom_rug(color = 'gray') +
  geom_vline(xintercept = mean(pool$MG_ID_MODEL_SCORE, na.rm = TRUE), color = 'blue', linetype = 'dashed')
```

```{r}
pool %>% select(MG_ID_MODEL_SCORE) %>% filter(!is.na(MG_ID_MODEL_SCORE)) %>% unlist() %>%
  quantile(probs = c(.25, .5, .75, .8, .85, .9, .95, .99))
```

Most modeled prospects have a model score < 0. Descriptive labels were also assigned to certain ranges of scores.

**Top tier:**

```{r}
pool %>% select(MG_ID_MODEL_SCORE, MG_ID_MODEL_DESC) %>% filter(MG_ID_MODEL_DESC == 'Top Tier') %>%
  unlist() %>% summary()
```

**Middle tier:**

```{r}
pool %>% select(MG_ID_MODEL_SCORE, MG_ID_MODEL_DESC) %>% filter(MG_ID_MODEL_DESC == 'Middle Tier') %>%
  unlist() %>% summary()
```

**Bottom tier:**

```{r}
pool %>% select(MG_ID_MODEL_SCORE, MG_ID_MODEL_DESC) %>% filter(MG_ID_MODEL_DESC == 'Bottom Tier') %>%
  unlist() %>% summary()
```

Now this is interesting - there is quite a bit of overlap.

```{r}
pool %>% filter(!is.na(MG_ID_MODEL_SCORE)) %>%
  ggplot(aes(x = MG_ID_MODEL_SCORE, color = MG_ID_MODEL_DESC)) +
  geom_density(alpha = .5) +
  geom_rug() +
  geom_vline(xintercept = mean(pool$MG_ID_MODEL_SCORE, na.rm = TRUE), color = 'blue', linetype = 'dashed')
```

This looks a bit like a mixture model - perhaps the model description label is the most likely class based on model score and some other input.

We can also look at cultivation score by ID model label.

```{r}
pool %>%filter(!is.na(MG_ID_MODEL_SCORE)) %>%
  ggplot(aes(x = CULTIVATION_SCORE, fill = MG_ID_MODEL_DESC)) +
  geom_histogram(binwidth = 1, alpha = .5, aes(y = ..density..)) +
  scale_x_continuous(breaks = seq(lower_bound, upper_bound, by = 2)) +
  facet_grid(MG_ID_MODEL_DESC ~ .)
```

```{r}
get_percentiles(
  lower_bound
  , upper_bound
  , pool %>% filter(MG_ID_MODEL_DESC == 'Bottom Tier') %>% select(CULTIVATION_SCORE) %>% unlist()
  , pool %>% filter(MG_ID_MODEL_DESC == 'Middle Tier') %>% select(CULTIVATION_SCORE) %>% unlist()
  , pool %>% filter(MG_ID_MODEL_DESC == 'Top Tier') %>% select(CULTIVATION_SCORE) %>% unlist()
) %>% select(score = x, bottom_tier = g1, middle_tier = g2, top_tier = g3)
```

Very interesting - it looks like people who have been more heavily engaged have lower cultivation scores, perhaps because they're no longer discovery prospects?

### Major gift prioritization scores

Repeat the previous analysis with the major gift prioritization scores.

```{r}
summary(pool$MG_PR_MODEL_SCORE)
```

A much higher proportion of prospects have a prioritization score than identification score. Besides the negative entries, this looks a bit like a probability model.

```{r}
pool %>% filter(!is.na(MG_PR_MODEL_SCORE)) %>%
  ggplot(aes(x = MG_PR_MODEL_SCORE)) +
  geom_density() +
  geom_rug(color = 'gray') +
  geom_vline(xintercept = mean(pool$MG_PR_MODEL_SCORE, na.rm = TRUE), color = 'blue', linetype = 'dashed')
```

Very strongly right-skewed. Here's the same plot with the scale adjusted.

```{r}
pool %>% filter(!is.na(MG_PR_MODEL_SCORE)) %>%
  ggplot(aes(x = MG_PR_MODEL_SCORE)) +
  geom_density() +
  geom_rug(color = 'gray') +
  geom_vline(xintercept = mean(pool$MG_PR_MODEL_SCORE, na.rm = TRUE), color = 'blue', linetype = 'dashed') +
  scale_y_sqrt(breaks = 2^(0:20), minor_breaks = NULL)
```

Examining the scores by descriptive prioritization model label:

```{r}
pool %>% filter(!is.na(MG_PR_MODEL_SCORE)) %>%
  ggplot(aes(x = MG_PR_MODEL_SCORE, color = MG_PR_MODEL_DESC)) +
  geom_density(alpha = .5) +
  geom_rug() +
  scale_y_sqrt(breaks = 2^(0:20), minor_breaks = NULL)
```

As before, there's overlap between the groups, but the long tail is entirely from the top tier group.

Finally, look at the distributions of cultivation scores.

```{r}
pool %>%filter(!is.na(MG_PR_MODEL_SCORE)) %>%
  ggplot(aes(x = CULTIVATION_SCORE, fill = MG_PR_MODEL_DESC)) +
  geom_histogram(binwidth = 1, alpha = .5, aes(y = ..density..)) +
  scale_x_continuous(breaks = seq(lower_bound, upper_bound, by = 2)) +
  facet_grid(MG_PR_MODEL_DESC ~ .)
```

```{r}
get_percentiles(
  lower_bound
  , upper_bound
  , pool %>% filter(MG_PR_MODEL_DESC == 'Bottom Tier') %>% select(CULTIVATION_SCORE) %>% unlist()
  , pool %>% filter(MG_PR_MODEL_DESC == 'Middle Tier') %>% select(CULTIVATION_SCORE) %>% unlist()
  , pool %>% filter(MG_PR_MODEL_DESC == 'Top Tier') %>% select(CULTIVATION_SCORE) %>% unlist()
) %>% select(score = x, bottom_tier = g1, middle_tier = g2, top_tier = g3)
```

As expected, the top tier prospects have much higher cultivation scores than the other groups.

# Relationship to giving