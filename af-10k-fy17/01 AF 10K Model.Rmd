---
title: "Annual Fund $10K Model Data Exploration"
output: html_notebook
---

# Goal

Clean up and explore the dataset generated with the `ksm-af-10k-data.sql` query with reusable R code.

# Setup

## R version

```{r get.sessionInfo}
sessionInfo()
```

## Required packages

My code makes use of several packages:

```{r get.packages}
scan('PACKAGES.txt', what = 'character')
```

This code will install and load them as necessary. First, install `devtools` and my `wranglR` package:

```{r get.wranglR}
# Check to see if devtools is unavailable
if (!('devtools' %in% utils::installed.packages()[, 'Package'])) {
  # If unavailable, install it
  install.packages('devtools')
}

# Check to see if wranglR is unavailable
if (!('wranglR' %in% utils::installed.packages()[, 'Package'])) {
  # If unavailable, use devtools to install it via GitHub
  devtools::install_github('phively/wranglR')
}
```

## Load libraries

Now load `wranglR` and use it to install or load the other required packages:

```{r load.packages, warning=FALSE, message=FALSE}
# Load wranglR
library(wranglR)

# Feed the libraries specified in PACKAGES.txt into wranglR's Libraries() function
Libraries(scan(file = 'PACKAGES.txt', what = 'character'))
```

## Data preparation

```{r load.data}
### Import the data
full.data <- read.csv('data/2017-12-01 AF 10K Model.csv', stringsAsFactors = FALSE, strip.white = TRUE,
                      colClasses = c('ID_NUMBER' = 'character',
                                     'HOUSEHOLD_ID' = 'character',
                                     'BIRTH_DT' = 'character')) %>%
  # Drop any null rows
  filter(!is.na(RN)) %>%
  # Drop row numbers
  select(-RN)

### Clean the data
full.data <- full.data %>%
  # Convert NA to 0
  mutate_all(
    funs(
      ifelse(is.na(.), 0, .)
    )
  ) %>%
  # Convert to date
  mutate(
      DOB = ToDate(BIRTH_DT, method = 'ymd')
  ) %>%
  # Convert certain character to factor
  mutate(
    # Factors
      RECORD_STATUS_CODE = factor(RECORD_STATUS_CODE) %>% relevel(ref = 'A') # Active
    , HOUSEHOLD_RECORD = factor(HOUSEHOLD_RECORD) %>% relevel(ref = 'AL') # Alumni
    , PROGRAM_GROUP = factor(PROGRAM_GROUP) %>% relevel(ref = 'FT') # Full-Time
    , PREF_ADDR_TYPE_CODE = factor(PREF_ADDR_TYPE_CODE) %>% relevel(ref = 'H') # Home
    , HOUSEHOLD_STATE = factor(HOUSEHOLD_STATE) %>% relevel(ref = 'IL') # Illinois
    , HOUSEHOLD_COUNTRY = factor(HOUSEHOLD_COUNTRY) %>% relevel(ref = 'United States')
    , HOUSEHOLD_CONTINENT = factor(HOUSEHOLD_CONTINENT) %>% relevel(ref = 'North America')
    , EVALUATION_RATING = factor(EVALUATION_RATING) %>% relevel(ref = '') # Unrated
    # Indicators
    , BUS_IS_EMPLOYED = factor(BUS_IS_EMPLOYED == 'Y')
    , BUS_HIGH_LVL_JOB_TITLE = factor(BUS_HIGH_LVL_JOB_TITLE != '')
    , BUS_CAREER_SPEC_FINANCE = factor(BUS_CAREER_SPEC_FINANCE != '')
    , BUS_GIFT_MATCH = factor(BUS_GIFT_MATCH == 'Y')
    , HAS_HOME_ADDR = factor(HAS_HOME_ADDR == 'Y')
    , HAS_ALT_HOME_ADDR = factor(HAS_ALT_HOME_ADDR == 'Y')
    , HAS_BUS_ADDR = factor(HAS_BUS_ADDR == 'Y')
    , HAS_SEASONAL_ADDR = factor(HAS_SEASONAL_ADDR == 'Y')
    , HAS_HOME_PHONE = factor(HAS_HOME_PHONE == 'Y')
    , HAS_BUS_PHONE = factor(HAS_BUS_PHONE == 'Y')
    , HAS_MOBILE_PHONE = factor(HAS_MOBILE_PHONE == 'Y')
    , HAS_HOME_EMAIL = factor(HAS_HOME_EMAIL == 'Y')
    , HAS_BUS_EMAIL = factor(HAS_BUS_EMAIL == 'Y')
    , KSM_PROSPECT_ACTIVE = factor(KSM_PROSPECT_ACTIVE == 'Y')
    , KSM_PROSPECT_ANY = factor(KSM_PROSPECT_ANY == 'Y')
  )
```

"Failed to parse" means `DOB` is NA due to invalid `BIRTH_DT` format.

# Data Exploration

## Diagnostics

**Observations** from `summary(full.data)`

  * Need to be cautious about the inserted 0s; e.g. discretize years?
  * Should gift amounts be inflation-indexed? (CPI-U adjustment)
  * DOB missing and impossible values: impute?

```{r plot.grad.year}
full.data %>% filter(FIRST_KSM_YEAR != 0) %>%
  ggplot(aes(x = FIRST_KSM_YEAR, fill = RECORD_STATUS_CODE)) + geom_histogram(alpha = .5, binwidth = 1) +
  facet_grid(RECORD_STATUS_CODE ~ .) + scale_y_log10()
```

  * Check 1800 grad year
  
```{r plot.dob}
full.data %>% filter(!is.na(DOB) & year(DOB) != 0) %>%
  ggplot(aes(x = year(DOB), fill = RECORD_STATUS_CODE)) + geom_histogram(alpha = .5, binwidth = 1) +
  facet_grid(RECORD_STATUS_CODE ~ .) + scale_y_log10()
```

  * Check the person with DOB year 0
  * Check people with DOB after 2000...or in general after they graduated?

## Inflation adjustment exploration

Plot largest nominal cash gift from each donor against the year in which it was made.

```{r plot.amt.by.year}
full.data %>% filter(GIVING_MAX_CASH_AMT > 0) %>%
  ggplot(aes(x = GIVING_MAX_CASH_YR, y = GIVING_MAX_CASH_AMT)) +
  geom_point() + geom_jitter(width = .25, height = 0) +
  scale_y_log10(breaks = 10^(-2:7)) + geom_smooth() +
   # Red line is linear trend
  geom_smooth(method = 'lm', color = 'red') +
  labs(title = "Nominal dollars by year")
```

Slight upward slope over the last 30-40 years.

```{r infl.adjust}
# Load historical CPI-U data
cpi.u <- read.csv('data/CPI 2017-09-01.csv', strip.white = TRUE) %>%
  mutate(
    AS_OF = mdy(AS_OF)
    , YEAR = CALENDAR_YEAR
  )
cpi.max <- cpi.u %>% filter(CALENDAR_YEAR == max(CALENDAR_YEAR)) %>% select(CPI_U_AVG) %>% as.numeric()
```

Plot largest inflation-adjusted cash gift (Sept 2017 dollars) from each donor against the year in which it was made.

```{r plot.cpiu.amt.by.year}
full.data %>% filter(GIVING_MAX_CASH_AMT > 0) %>%
  # Join CPI-U columns
  mutate(YEAR = GIVING_MAX_CASH_YR) %>%
  inner_join(cpi.u, by = c('YEAR')) %>%
  # Compute inflation-adjusted amount
  mutate(CPIU_MAX_CASH_AMT = GIVING_MAX_CASH_AMT * cpi.max/CPI_U_AVG) %>%
  # Plot results
  ggplot(aes(x = YEAR, y = CPIU_MAX_CASH_AMT)) +
  geom_point() + geom_jitter(width = .25, height = 0) +
  scale_y_log10(breaks = 10^(-2:7)) + geom_smooth() +
  # Red line is linear trend
  geom_smooth(method = 'lm', color = 'red') +
  labs(title = "September 2017 dollars by year")
```

Inflation-adjusted there's a slight *downward* slope over time. Does look remarkably consistent over time.

## Response variable transformations

For Annual Giving, largest single cash gift is the logical response variable.

```{r summary2}
summary2 <- function(x) {
  summary(x) %>% c(
    StDev = sd(x)
    , Skewnewss = e1071::skewness(x)
    , Kurtosis = e1071::kurtosis(x)
  ) %>% print(digits = 3)
}
```
```{r rv.stats}
full.data$GIVING_MAX_CASH_AMT %>% summary2()
# Log10 transformation, no 0
{full.data %>% filter(GIVING_MAX_CASH_AMT > 0)}$GIVING_MAX_CASH_AMT %>% log10() %>% summary2()
# Log10 transformation, with 0
{full.data$GIVING_MAX_CASH_AMT + 1} %>% log10() %>% summary2()
```

Giving is left-truncated at 0. I'd previously looked into alternate distributions with different datasets but the additional complexity was not worth it.

```{r rv.trans.plot}
# Density histogram
full.data %>% filter(GIVING_MAX_CASH_AMT > 0) %>%
  ggplot(aes(x = GIVING_MAX_CASH_AMT)) +
  geom_histogram(aes(y = ..density..), bins = 50, alpha = .5) +
  geom_density() +
  scale_x_log10(breaks = 10^(-2:7),
                minor_breaks = c(.25 * 10^(-2:7), .5 * 10^(-2:7), .75 * 10^(-2:7)),
                labels = scales::dollar) +
  theme(panel.grid.minor.x = element_line(linetype = 'dashed')) +
  labs(title = 'No 0')
```

Log scale appears to be a decent choice, though it's still right-skewed.

```{r rv.boxcox}
# Box-Cox analysis
bc <- lm(log10(GIVING_MAX_CASH_AMT) ~ GIVING_MAX_CASH_YR, data = full.data %>% filter(GIVING_MAX_CASH_AMT > 1)) %>%
  MASS::boxcox()
bc$x[which(bc$y == max(bc$y))]
```

According to this the best transformation on the 1-variable model is approximately $\sqrt[4]{\log(x)}$, which is quite hard to interpret. Log transformation is likely sufficient and has a reasonable explanation (error term $\epsilon$ enters multiplicatively).

## Response variable correlations

```{r rv.plotter}
# ggplot2 boxplotting function from colname
boxplotter <- function(cname, data = full.data) {
  data %>% select(GIVING_MAX_CASH_AMT) %>% cbind(x = data[, cname]) %>%
    filter(GIVING_MAX_CASH_AMT > 0) %>%
    ggplot(aes(x = x, y = GIVING_MAX_CASH_AMT)) +
    geom_boxplot(alpha = .6) +
    scale_y_log10(breaks = 10^(-2:7), labels = scales::dollar) +
    labs(x = cname)
}

# ggplot2 scatterplotting function from colname
scatterplotter <- function(cname, data = full.data) {
  data %>% select(GIVING_MAX_CASH_AMT) %>% cbind(x = data[, cname]) %>%
    filter(GIVING_MAX_CASH_AMT > 0) %>%
    ggplot(aes(x = x, y = GIVING_MAX_CASH_AMT)) +
    geom_point(alpha = .6) +
    geom_smooth() +
    geom_smooth(method = 'lm', color = 'red') +
    scale_y_log10(breaks = 10^(-2:7), labels = scales::dollar) +
    labs(x = cname)
}
  
```


### Categorical variables

```{r rv.cat.rsc}
summary(full.data$RECORD_STATUS_CODE)
boxplotter('RECORD_STATUS_CODE')
```

Good number within each factor and a meaningful indicator.

```{r rv.cat.hhr}
summary(full.data$HOUSEHOLD_RECORD)
boxplotter('HOUSEHOLD_RECORD')
```

Only a few students; good number of nonalumni.
**Consider combining AL and ST**

```{r rv.cat.hhprim}
summary(full.data$HH_PRIMARY %>% as.factor())
boxplotter('HH_PRIMARY')
```

Should not include `N` in analysis as it duplicates a `Y` elsewhere in the file.
**EXCLUDE**

```{r rv.cat.pg}
summary(full.data$PROGRAM_GROUP)
boxplotter('PROGRAM_GROUP')
```

Only 20 UNK; others have a good number of rows.
**Consider dropping UNK or treating as nonalum**

```{r rv.cat.patc}
summary(full.data$PREF_ADDR_TYPE_CODE)
boxplotter('PREF_ADDR_TYPE_CODE')
```

Several with very few examples; a few options here. Could combine all the Home-like and Business-like, and leave an Other for seasonal etc. Could also roll all the < 500, say, into an Other.
**Consider combining categories**

```{r rv.cat.hhs}
summary(full.data$HOUSEHOLD_STATE)
boxplotter('HOUSEHOLD_STATE')
```

This appears to include Canadian and Australian states. Could also combine some of the lower-population areas.
**Consider combining, perhaps based on region**

```{r rv.cat.hhc}
summary(full.data$HOUSEHOLD_CONTINENT)
boxplotter('HOUSEHOLD_CONTINENT')
```

Clear difference between those with and without an address; probably fine to include in model to suss out other differences.

```{r rv.cat.bie}
summary(full.data$BUS_IS_EMPLOYED)
boxplotter('BUS_IS_EMPLOYED')
```

Looks fine.

```{r rv.cat.bhljt}
summary(full.data$BUS_HIGH_LVL_JOB_TITLE)
boxplotter('BUS_HIGH_LVL_JOB_TITLE')
```

Looks fine.

```{r rv.cat.bcsf}
summary(full.data$BUS_CAREER_SPEC_FINANCE)
boxplotter('BUS_CAREER_SPEC_FINANCE')
```

Looks fine.

```{r rv.cat.bgm}
summary(full.data$BUS_GIFT_MATCH)
boxplotter('BUS_GIFT_MATCH')
```

Very few that have matching companies; apparently this is not tracked consistently?
**EXCLUDE**

```{r rv.cat.hha}
summary(full.data$HAS_HOME_ADDR)
boxplotter('HAS_HOME_ADDR')
```

Looks fine.

```{r rv.cat.haha}
summary(full.data$HAS_ALT_HOME_ADDR)
boxplotter('HAS_ALT_HOME_ADDR')
```

Looks fine.

```{r rv.cat.hba}
summary(full.data$HAS_BUS_ADDR)
boxplotter('HAS_BUS_ADDR')
```

Looks fine.

```{r rv.cat.hsa}
summary(full.data$HAS_SEASONAL_ADDR)
boxplotter('HAS_SEASONAL_ADDR')
```

Low count.
**Consider combining with alternate home address**

```{r rv.cat.hhp}
summary(full.data$HAS_HOME_PHONE)
boxplotter('HAS_HOME_PHONE')
```

Looks fine.

```{r rv.cat.hbp}
summary(full.data$HAS_BUS_PHONE)
boxplotter('HAS_BUS_PHONE')
```

Looks fine.

```{r rv.cat.hmp}
summary(full.data$HAS_MOBILE_PHONE)
boxplotter('HAS_MOBILE_PHONE')
```



```{r rv.cat.hhe}
summary(full.data$HAS_HOME_EMAIL)
boxplotter('HAS_HOME_EMAIL')
```

Looks fine.

```{r rv.cat.hbe}
summary(full.data$HAS_BUS_EMAIL)
boxplotter('HAS_BUS_EMAIL')
```

Looks fine.

```{r rv.cat.eval}
summary(full.data$EVALUATION_RATING)
boxplotter('EVALUATION_RATING')
```

Would likely combine all the $1M+ levels. Note that the evaluation rating process is causally associated with solicitations and thus gift size.
**CAUTION - endogenous**

```{r rv.cat.kpact}
summary(full.data$KSM_PROSPECT_ACTIVE)
boxplotter('KSM_PROSPECT_ACTIVE')
```

Looks fine.

```{r rv.cat.kpany}
summary(full.data$KSM_PROSPECT_ANY)
boxplotter('KSM_PROSPECT_ANY')
```

Looks fine.
**Consider making a new factor combining `KSM_PROSPECT_ACTIVE` and `KSM_PROSPECT_ANY`**

```{r rv.cat.kpanyall}
# Derived variable
full.data <- full.data %>% mutate(
  KSM_PROSPECT = case_when(
    KSM_PROSPECT_ACTIVE == TRUE ~ 'Current'
    , KSM_PROSPECT_ANY == TRUE ~ 'Past'
    , TRUE ~ 'No') %>% factor()
)
summary(full.data$KSM_PROSPECT)
boxplotter('KSM_PROSPECT')

```

Looks good.

### Numeric variables

```{r rv.num.ksmyr}
summary2(full.data$FIRST_KSM_YEAR)
scatterplotter('FIRST_KSM_YEAR', full.data %>% filter(FIRST_KSM_YEAR > 0))
```



```{r rv.num.gfirstyr}
summary2(full.data$GIVING_FIRST_YEAR)
scatterplotter('GIVING_FIRST_YEAR')
```



```{r rv.num.gfirstcashamt}
summary2(full.data$GIVING_FIRST_YEAR_CASH_AMT)
scatterplotter('GIVING_FIRST_YEAR_CASH_AMT'
               , full.data %>% filter(GIVING_FIRST_YEAR_CASH_AMT > 0)) +
  scale_x_log10(breaks = 10^(-2:7), labels = scales::dollar)
```



```{r rv.num.gfirstplgamt}
summary2(full.data$GIVING_FIRST_YEAR_PLEDGE_AMT)
scatterplotter('GIVING_FIRST_YEAR_PLEDGE_AMT'
               , full.data %>% filter(GIVING_FIRST_YEAR_PLEDGE_AMT > 0)) +
  scale_x_log10(breaks = 10^(-2:7), labels = scales::dollar)
```

# Data file cleanup

  * R script to clean data file for processing
  * Should include a function taking data file path as an argument